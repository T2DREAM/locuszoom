"use strict";!function(t,e){if("function"==typeof define&&define.amd)define(["locuszoom","d3"],function(t,a){return e(t,a)});else if("object"==typeof module&&module.exports)module.exports=e(require("locuszoom"),require("d3"));else{t.LocusZoom.ext.Data||(t.LocusZoom.ext.Data={});var a=e(t.LocusZoom,t.d3);t.LocusZoom.ext.Data.IntervalLZ=a.IntervalLZ}}(this,function(i,_){var t,a=i.Data.Source.extend(function(t){this.parseInit(t)},"IntervalLZ");return a.prototype.getURL=function(t,a,e){var i=a.header.bedtracksource||this.params.source;return this.url+"?filter=id in "+i+" and chromosome eq '"+t.chr+"' and start le "+t.end+" and end ge "+t.start},i.Dashboard.Components.add("toggle_split_tracks",function(e){if(i.Dashboard.Component.apply(this,arguments),e.data_layer_id||(e.data_layer_id="intervals"),!this.parent_panel.data_layers[e.data_layer_id])throw new Error("Dashboard toggle split tracks component missing valid data layer ID");this.update=function(){var t=this.parent_panel.data_layers[e.data_layer_id],a=t.layout.split_tracks?"Merge Tracks":"Split Tracks";return this.button?(this.button.setHtml(a),this.button.show(),this.parent.position(),this):(this.button=new i.Dashboard.Component.Button(this).setColor(e.color).setHtml(a).setTitle("Toggle whether tracks are split apart or merged together").setOnclick(function(){t.toggleSplitTracks(),this.scale_timeout&&clearTimeout(this.scale_timeout),this.scale_timeout=setTimeout(function(){this.parent_panel.scaleHeightToData(),this.parent_plot.positionPanels()}.bind(this),0),this.update()}.bind(this)),this.update())}}),i.ScaleFunctions.add("to_rgb",function(t,a){return a?"rgb("+a+")":null}),i.DataLayers.add("intervals",function(t){return this.DefaultLayout={start_field:"start",end_field:"end",track_label_field:"state_name",track_split_field:"state_id",track_split_order:"DESC",track_split_legend_to_y_axis:2,split_tracks:!0,track_height:15,track_vertical_spacing:3,bounding_box_padding:2,always_hide_legend:!1,color:"#B8B8B8",fill_opacity:1,tooltip_positioning:"vertical"},t=i.Layouts.merge(t,this.DefaultLayout),i.DataLayer.apply(this,arguments),this.getElementStatusNodeId=function(t){return this.layout.split_tracks?(this.getBaseId()+"-statusnode-"+t[this.layout.track_split_field]).replace(/[^\w]/g,"_"):this.getElementId(t)+"-statusnode"}.bind(this),this.getTrackHeight=function(){return this.layout.track_height+this.layout.track_vertical_spacing+2*this.layout.bounding_box_padding},this.tracks=1,this.previous_tracks=1,this.interval_track_index={1:[]},this._applyLayoutOptions=function(){var r=this,t=this._base_layout,a=this.layout,e=t.color.find(function(t){return t.scale_function&&"categorical_bin"===t.scale_function}),s=a.color.find(function(t){return t.scale_function&&"categorical_bin"===t.scale_function});if(!e)throw new Error("Interval tracks must define a `categorical_bin` color scale");var i=e.parameters.categories.length&&e.parameters.values.length,n=t.legend&&t.legend.length;if(!!i^!!n)throw new Error("To use a manually specified color scheme, both color and legend options must be set.");var l=t.color.find(function(t){return t.scale_function&&"to_rgb"===t.scale_function}),o=l&&l.field,d=this._generateCategoriesFromData(this.data,o);if(!i&&!n){var c=this._makeColorScheme(d);s.parameters.categories=d.map(function(t){return t[0]}),s.parameters.values=c,this.layout.legend=d.map(function(t,a){var e=t[0],i={shape:"rect",width:9,label:t[1],color:s.parameters.values[a]};return i[r.layout.track_split_field]=e,i})}}.bind(this),this.assignTracks=function(){if(this._applyLayoutOptions(),this.previous_tracks=this.tracks,this.tracks=0,this.interval_track_index={1:[]},this.track_split_field_index={},this.layout.track_split_field&&this.layout.split_tracks){this.data.forEach(function(t){this.track_split_field_index[t[this.layout.track_split_field]]=null}.bind(this));var t=Object.keys(this.track_split_field_index);"DESC"===this.layout.track_split_order&&t.reverse(),t.forEach(function(t){this.track_split_field_index[t]=this.tracks+1,this.interval_track_index[this.tracks+1]=[],this.tracks++}.bind(this))}return this.data.forEach(function(t,a){if((this.data[a].parent=this).data[a].display_range={start:this.parent.x_scale(Math.max(t[this.layout.start_field],this.state.start)),end:this.parent.x_scale(Math.min(t[this.layout.end_field],this.state.end))},this.data[a].display_range.width=this.data[a].display_range.end-this.data[a].display_range.start,this.data[a].display_domain={start:this.parent.x_scale.invert(this.data[a].display_range.start),end:this.parent.x_scale.invert(this.data[a].display_range.end)},this.data[a].display_domain.width=this.data[a].display_domain.end-this.data[a].display_domain.start,this.layout.track_split_field&&this.layout.split_tracks){var e=this.data[a][this.layout.track_split_field];this.data[a].track=this.track_split_field_index[e],this.interval_track_index[this.data[a].track].push(a)}else{this.tracks=1,this.data[a].track=null;for(var i=1;null===this.data[a].track;){var r=!1;this.interval_track_index[i].map(function(t){if(!r){var a=Math.min(t.display_range.start,this.display_range.start);Math.max(t.display_range.end,this.display_range.end)-a<t.display_range.width+this.display_range.width&&(r=!0)}}.bind(this.data[a])),r?++i>this.tracks&&(this.tracks=i,this.interval_track_index[i]=[]):(this.data[a].track=i,this.interval_track_index[i].push(this.data[a]))}}}.bind(this)),this},this.render=function(){var n,l,o,d,c,h;this.assignTracks(),this.svg.group.selectAll(".lz-data_layer-intervals-statusnode.lz-data_layer-intervals-shared").remove(),Object.keys(this.track_split_field_index).forEach(function(t){var a={};a[this.layout.track_split_field]=t;var e={display:this.layout.split_tracks?null:"none"};this.svg.group.insert("rect",":first-child").attr("id",this.getElementStatusNodeId(a)).attr("class","lz-data_layer-intervals lz-data_layer-intervals-statusnode lz-data_layer-intervals-shared").attr("rx",this.layout.bounding_box_padding).attr("ry",this.layout.bounding_box_padding).attr("width",this.parent.layout.cliparea.width).attr("height",this.getTrackHeight()-this.layout.track_vertical_spacing).attr("x",0).attr("y",(this.track_split_field_index[t]-1)*this.getTrackHeight()).style(e)}.bind(this));var t=this.svg.group.selectAll("g.lz-data_layer-intervals").data(this.data,function(t){return t[this.layout.id_field]}.bind(this));return t.enter().append("g").attr("class","lz-data_layer-intervals"),t.attr("id",function(t){return this.getElementId(t)}.bind(this)).each(function(t){var e=t.parent,a={display:e.layout.split_tracks?"none":null},i=_.select(this).selectAll("rect.lz-data_layer-intervals.lz-data_layer-intervals-statusnode.lz-data_layer-intervals-statusnode-discrete").data([t],function(t){return e.getElementId(t)+"-statusnode"});i.enter().insert("rect",":first-child").attr("class","lz-data_layer-intervals lz-data_layer-intervals-statusnode lz-data_layer-intervals-statusnode-discrete"),i.attr("id",function(t){return e.getElementId(t)+"-statusnode"}).attr("rx",function(){return e.layout.bounding_box_padding}).attr("ry",function(){return e.layout.bounding_box_padding}).style(a),n=function(t){return t.display_range.width+2*e.layout.bounding_box_padding},l=function(){return e.getTrackHeight()-e.layout.track_vertical_spacing},o=function(t){return t.display_range.start-e.layout.bounding_box_padding},d=function(t){return(t.track-1)*e.getTrackHeight()},i.attr("width",n).attr("height",l).attr("x",o).attr("y",d),i.exit().remove();var r=_.select(this).selectAll("rect.lz-data_layer-intervals.lz-interval_rect").data([t],function(t){return t[e.layout.id_field]+"_interval_rect"});r.enter().append("rect").attr("class","lz-data_layer-intervals lz-interval_rect"),l=e.layout.track_height,n=function(t){return t.display_range.width},o=function(t){return t.display_range.start},d=function(t){return(t.track-1)*e.getTrackHeight()+e.layout.bounding_box_padding},c=function(t,a){return e.resolveScalableParameter(e.layout.color,t,a)},h=function(t,a){return e.resolveScalableParameter(e.layout.fill_opacity,t,a)},r.attr("width",n).attr("height",l).attr("x",o).attr("y",d).attr("fill",c).attr("fill-opacity",h),r.exit().remove();var s=_.select(this).selectAll("rect.lz-data_layer-intervals.lz-clickarea").data([t],function(t){return t.interval_name+"_clickarea"});s.enter().append("rect").attr("class","lz-data_layer-intervals lz-clickarea"),s.attr("id",function(t){return e.getElementId(t)+"_clickarea"}).attr("rx",function(){return e.layout.bounding_box_padding}).attr("ry",function(){return e.layout.bounding_box_padding}),n=function(t){return t.display_range.width},l=function(){return e.getTrackHeight()-e.layout.track_vertical_spacing},o=function(t){return t.display_range.start},d=function(t){return(t.track-1)*e.getTrackHeight()},s.attr("width",n).attr("height",l).attr("x",o).attr("y",d),s.exit().remove(),s.on("click",function(t){t.parent.parent.emit("element_clicked",t,!0)}.bind(this)),e.applyBehaviors(s)}),t.exit().remove(),this.previous_tracks!==this.tracks&&this.updateSplitTrackAxis(),this.parent&&this.parent.legend&&this.parent.legend.render(),this},this._getTooltipPosition=function(t){var a=_.select("#"+this.getElementStatusNodeId(t.data)).node().getBBox();return{x_min:t.data.display_range.start,x_max:t.data.display_range.end,y_min:a.y,y_max:a.y+a.height}},this.updateSplitTrackAxis=function(){var i=!!this.layout.track_split_legend_to_y_axis&&"y"+this.layout.track_split_legend_to_y_axis;if(this.layout.split_tracks){var r=+this.tracks||0,t=+this.layout.track_height||0,a=2*(+this.layout.bounding_box_padding||0)+(+this.layout.track_vertical_spacing||0),e=r*t+(r-1)*a;this.parent.scaleHeightToData(e),i&&this.parent.legend&&(this.parent.legend.hide(),this.parent.layout.axes[i]={render:!0,ticks:[],range:{start:e-this.layout.track_height/2,end:this.layout.track_height/2}},this.layout.legend.forEach(function(t){var a=t[this.layout.track_split_field],e=this.track_split_field_index[a];e&&("DESC"===this.layout.track_split_order&&(e=Math.abs(e-r-1)),this.parent.layout.axes[i].ticks.push({y:e,text:t.label}))}.bind(this)),this.layout.y_axis={axis:this.layout.track_split_legend_to_y_axis,floor:1,ceiling:r},this.parent.render()),this.parent_plot.positionPanels()}else i&&this.parent.legend&&(this.layout.always_hide_legend||this.parent.legend.show(),this.parent.layout.axes[i]={render:!1},this.parent.render());return this},this.toggleSplitTracks=function(){return this.layout.split_tracks=!this.layout.split_tracks,this.parent.legend&&!this.layout.always_hide_legend&&(this.parent.layout.margin.bottom=5+(this.layout.split_tracks?0:this.parent.legend.layout.height+5)),this.render(),this.updateSplitTrackAxis(),this},this._makeColorScheme=function(t){if(t.find(function(t){return t[2]}))return t.map(function(t){return t[2]});var a=t.length;return a<=15?["rgb(212,212,212)","rgb(192,192,192)","rgb(128,128,128)","rgb(189,183,107)","rgb(233,150,122)","rgb(205,92,92)","rgb(138,145,208)","rgb(102,205,170)","rgb(255,255,0)","rgb(194,225,5)","rgb(0,100,0)","rgb(0,128,0)","rgb(50,205,50)","rgb(255,69,0)","rgb(255,0,0)"]:a<=18?["rgb(212,212,212)","rgb(192,192,192)","rgb(128,128,128)","rgb(189,183,107)","rgb(205,92,92)","rgb(138,145,208)","rgb(102,205,170)","rgb(255,255,0)","rgb(255,195,77)","rgb(255,195,77)","rgb(194,225,5)","rgb(194,225,5)","rgb(0,100,0)","rgb(0,128,0)","rgb(255,69,0)","rgb(255,69,0)","rgb(255,69,0)","rgb(255,0,0)"]:["rgb(212,212,212)","rgb(128,128,128)","rgb(112,48,160)","rgb(230,184,183)","rgb(138,145,208)","rgb(102,205,170)","rgb(255,255,102)","rgb(255,255,0)","rgb(255,255,0)","rgb(255,255,0)","rgb(255,195,77)","rgb(255,195,77)","rgb(255,195,77)","rgb(194,225,5)","rgb(194,225,5)","rgb(194,225,5)","rgb(194,225,5)","rgb(0,150,0)","rgb(0,128,0)","rgb(0,128,0)","rgb(0,128,0)","rgb(255,69,0)","rgb(255,69,0)","rgb(255,69,0)","rgb(255,0,0)"]},this._generateCategoriesFromData=function(t,i){var r=this,a=this._base_layout.legend;if(a&&a.length)return a.map(function(t){return[t[r.layout.track_split_field],t.label,t.color]});var s={},n=[];return t.forEach(function(t,a){var e=t[r.layout.track_split_field];s.hasOwnProperty(e)||(s[e]=null,n.push([e,t[r.layout.track_label_field],t[i]]))}),n}.bind(this),this}),i.Layouts.add("tooltip","standard_intervals",{namespace:{intervals:"intervals"},closable:!1,show:{or:["highlighted","selected"]},hide:{and:["unhighlighted","unselected"]},html:"{{{{namespace[intervals]}}state_name|htmlescape}}<br>{{{{namespace[intervals]}}start|htmlescape}}-{{{{namespace[intervals]}}end|htmlescape}}"}),i.Layouts.add("data_layer","intervals",{namespace:{intervals:"intervals"},id:"intervals",type:"intervals",fields:["{{namespace[intervals]}}start","{{namespace[intervals]}}end","{{namespace[intervals]}}state_id","{{namespace[intervals]}}state_name","{{namespace[intervals]}}itemRgb"],id_field:"{{namespace[intervals]}}start",start_field:"{{namespace[intervals]}}start",end_field:"{{namespace[intervals]}}end",track_split_field:"{{namespace[intervals]}}state_name",track_label_field:"{{namespace[intervals]}}state_name",split_tracks:!1,always_hide_legend:!0,color:[{field:"{{namespace[intervals]}}itemRgb",scale_function:"to_rgb"},{field:"{{namespace[intervals]}}state_name",scale_function:"categorical_bin",parameters:{categories:[],values:[],null_value:"#B8B8B8"}}],legend:[],behaviors:{onmouseover:[{action:"set",status:"highlighted"}],onmouseout:[{action:"unset",status:"highlighted"}],onclick:[{action:"toggle",status:"selected",exclusive:!0}],onshiftclick:[{action:"toggle",status:"selected"}]},tooltip:i.Layouts.get("tooltip","standard_intervals",{unnamespaced:!0})}),i.Layouts.add("panel","intervals",{id:"intervals",width:1e3,height:50,min_width:500,min_height:50,margin:{top:25,right:150,bottom:5,left:50},dashboard:(t=i.Layouts.get("dashboard","standard_panel",{unnamespaced:!0}),t.components.push({type:"toggle_split_tracks",data_layer_id:"intervals",position:"right"}),t),axes:{},interaction:{drag_background_to_pan:!0,scroll_to_zoom:!0,x_linked:!0},legend:{hidden:!0,orientation:"horizontal",origin:{x:50,y:0},pad_from_bottom:5},data_layers:[i.Layouts.get("data_layer","intervals",{unnamespaced:!0})]}),i.Layouts.add("plot","interval_association",{state:{},width:800,height:550,responsive_resize:"both",min_region_scale:2e4,max_region_scale:1e6,dashboard:i.Layouts.get("dashboard","standard_plot",{unnamespaced:!0}),panels:[i.Layouts.get("panel","association",{unnamespaced:!0,width:800,proportional_height:225/570}),i.Layouts.get("panel","intervals",{unnamespaced:!0,proportional_height:120/570}),i.Layouts.get("panel","genes",{unnamespaced:!0,width:800,proportional_height:225/570})]}),{IntervalLZ:a}});
//# sourceMappingURL=lz-intervals-track.min.js.map
